- name: Install Required Packages
  block:
    - name: Get Installed Packages
      ansible.builtin.package_facts:
        manager: auto
        strategy: all

    - name: Set Required Packages
      ansible.builtin.set_fact:
        required_packages:
          - e2fsprogs
          - parted
          - xfsprogs

    - name: Get Missing Packages
      ansible.builtin.set_fact:
        missing_packages: "{{ required_packages | difference(ansible_facts.packages.keys() | list) }}"

    - name: Install Missing Packages
      become: true
      when: "{{ missing_packages | length > 0 }}"
      ansible.builtin.package:
        name: "{{ missing_packages }}"
        state: present

- name: Identify Cloud Provider
  block:
    - name: Get Cloud-Init Signature
      ansible.builtin.command: cloud-id
      register: cloud_id

    - name: Get Virtualization Engine
      ansible.builtin.command: systemd-detect-virt
      register: virtualization_engine

- name: Create Symlink Map based on KVM Disk Serial
  when:
    - cloud_id.stdout == "nocloud"
    - virtualization_engine.stdout == "kvm"
  block:
    - name: Get Devices
      ansible.builtin.command: lsblk -J -o TYPE,SERIAL,PATH
      register: installed_devices

    - name: Filter Out Non-Disk Devices
      ansible.builtin.set_fact:
        disk_devices: "{{ (installed_devices.stdout | from_json).blockdevices | selectattr('type','equalto','disk') | list }}"

    - name: Create Symlink Map
      ansible.builtin.set_fact:
        symlink_map: "{{ dict((disk_devices | map(attribute='serial')) | zip(disk_devices | map(attribute='path'))) }}"

- name: Create Partitions Variable
  block:
    - name: Initialize Partitions Variable with Lazy Injection of Disk ID
      ansible.builtin.set_fact:
        temp: "{{ (temp | default([])) + (item.value.partitions | dict2items | map('combine', {'disk': item.key}) | list) }}"
      loop: "{{ vdisks | dict2items }}"

    - name: Format Cleanup
      ansible.builtin.set_fact:
        partitions: "{{ partitions | default({}) | combine({item.key: item.value | combine({'disk': item.disk})}) }}"
      loop: "{{ temp }}"

    - name: Inject Accumulative Variables
      block:
        - name: Create Keys and Size Accumulator
          ansible.builtin.set_fact:
            partition_keys: "{{ partition_keys | default({}) | combine({item: []}) }}"
            device_numbers: "{{ size_accumulators | default({}) | combine({item: []}) }}"
            size_accumulators: "{{ size_accumulators | default({}) | combine({item: []}) }}"
          loop: "{{ partitions | dict2items | map(attribute='value.disk') | unique }}"

        - name: Fill Keys and Accumulator
          ansible.builtin.set_fact:
            partition_keys: "{{ partition_keys | combine({item.value.disk: partition_keys[item.value.disk] + [item.key]}) }}"
            size_accumulators: "{{ size_accumulators | combine({item.value.disk: size_accumulators[item.value.disk] + [size_accumulators[item.value.disk] | last | default(0) + item.value.size]}) }}"
            device_numbers: "{{ device_numbers | combine({item.value.disk: device_numbers[item.value.disk] + [device_numbers[item.value.disk] | last | default(0) + 1]}) }}"
          loop: "{{ partitions | dict2items }}"

        - name: Flatten Keys and Accumulator
          ansible.builtin.set_fact:
            partition_keys: "{{ partition_keys | dict2items | map(attribute='value') | flatten }}"
            size_accumulators: "{{ size_accumulators | dict2items | map(attribute='value') | flatten }}"
            device_numbers: "{{ device_numbers | dict2items | map(attribute='value') | flatten }}"

        - name: Create Partition End Addresses Map
          ansible.builtin.set_fact:
            end_address_map: "{{ dict(partition_keys | zip(size_accumulators)) }}"
            device_number_map: "{{ dict(partition_keys | zip(device_numbers)) }}"

        - name: Inject End Addresses
          ansible.builtin.set_fact:
            partitions: "{{ partitions | combine({item.key: item.value | combine({'end_address': end_address_map[item.key] * 1024})}) }}"
          loop: "{{ partitions | dict2items }}"

        - name: Inject Start Addresses
          ansible.builtin.set_fact:
            partitions: "{{ partitions | combine({item.key: item.value | combine({'start_address': (end_address_map[item.key] - item.value.size) * 1024})}) }}"
          loop: "{{ partitions | dict2items }}"

        - name: Inject Partition Device Numbers
          ansible.builtin.set_fact:
            partitions: "{{ partitions | combine({item.key: item.value | combine({'device_number': device_number_map[item.key]})}) }}"
          loop: "{{ partitions | dict2items }}"

    - name: Inject Disk Device Source
      ansible.builtin.set_fact:
        partitions: "{{ partitions | combine({item.key: item.value | combine({'disk_source': symlink_map[item.value.disk]})}) }}"
      loop: "{{ partitions | dict2items }}"

    - name: Inject Migration Flag
      block:
        - name: Check if Target Directories already exist
          become: true
          ansible.builtin.stat:
            path: "{{ item.value.target }}"
          loop: "{{ partitions | dict2items }}"
          register: target_existence

        - name: Inject Migration Flag
          ansible.builtin.set_fact:
            partitions: "{{ partitions | combine({item.key: item.value | combine({'migration': target_existence.results[index].stat.exists})}) }}"
          loop: "{{ partitions | dict2items }}"
          loop_control:
            index_var: index

    - name: Inject Filesystem Options
      block:
        - name: Get Filesystems
          become: true
          ansible.builtin.command: "findmnt -J {{ item.value.target }}"
          ignore_errors: true
          register: filesystems
          loop: "{{ partitions | dict2items }}"

        - name: Inject Filesystem Options
          ansible.builtin.set_fact:
            partitions: "{{ partitions | combine({item.key: item.value | combine({'options': (filesystems.results[index].stdout | from_json).filesystems[0].options if filesystems.results[index].rc == 0 else 'defaults'})}) }}"
          loop: "{{ partitions | dict2items }}"
          loop_control:
            index_var: index
